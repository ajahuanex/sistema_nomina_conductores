---
import MainLayout from '../../layouts/MainLayout.astro';
---

<MainLayout title="Conductores - DRTC Puno">
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Gestión de Conductores</h1>
          <p class="text-sm text-gray-600">Registro y administración de conductores</p>
        </div>
        <div class="flex items-center gap-4">
          <div id="userInfo" class="text-right">
            <p class="text-sm font-medium text-gray-900"></p>
            <p class="text-xs text-gray-600"></p>
          </div>
          <a href="/dashboard" class="text-sm text-blue-600 hover:text-blue-700">
            ← Volver al Dashboard
          </a>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Filtros y búsqueda -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex flex-col md:flex-row gap-4 items-end">
          <!-- Búsqueda -->
          <div class="flex-1">
            <label for="search" class="block text-sm font-medium text-gray-700 mb-2">
              Buscar
            </label>
            <input
              type="text"
              id="search"
              placeholder="DNI, nombre, licencia..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          <!-- Filtro por estado -->
          <div class="w-full md:w-48">
            <label for="estadoFilter" class="block text-sm font-medium text-gray-700 mb-2">
              Estado
            </label>
            <select
              id="estadoFilter"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">Todos</option>
              <option value="pendiente">Pendiente</option>
              <option value="habilitado">Habilitado</option>
              <option value="observado">Observado</option>
              <option value="suspendido">Suspendido</option>
              <option value="revocado">Revocado</option>
            </select>
          </div>

          <!-- Botón buscar -->
          <button
            id="searchButton"
            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            Buscar
          </button>

          <!-- Botón nuevo conductor -->
          <a
            href="/conductores/nuevo"
            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-center"
          >
            + Nuevo Conductor
          </a>
        </div>
      </div>

      <!-- Tabla de conductores -->
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  DNI
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Conductor
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Licencia
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Empresa
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Estado
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Acciones
                </th>
              </tr>
            </thead>
            <tbody id="conductoresTableBody" class="bg-white divide-y divide-gray-200">
              <!-- Loading state -->
              <tr id="loadingRow">
                <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                  Cargando conductores...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Paginación -->
        <div class="bg-gray-50 px-6 py-4 flex items-center justify-between border-t border-gray-200">
          <div class="text-sm text-gray-700">
            Mostrando <span id="showingFrom">0</span> a <span id="showingTo">0</span> de <span id="totalItems">0</span> conductores
          </div>
          <div class="flex gap-2">
            <button
              id="prevPage"
              class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              Anterior
            </button>
            <button
              id="nextPage"
              class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              Siguiente
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>
</MainLayout>

<script>
  import { conductoresService, type Conductor } from '../../services/conductores';

  // Estado
  let currentPage = 1;
  const pageSize = 10;
  let totalPages = 1;

  // Verificar autenticación
  const token = localStorage.getItem('access_token');
  const userStr = localStorage.getItem('user');

  if (!token || !userStr) {
    window.location.href = '/login';
  }

  // Mostrar información del usuario
  try {
    const user = JSON.parse(userStr);
    const userInfoDiv = document.getElementById('userInfo');
    if (userInfoDiv) {
      userInfoDiv.querySelector('p:first-child')!.textContent = `${user.nombres} ${user.apellidos}`;
      userInfoDiv.querySelector('p:last-child')!.textContent = user.rol;
    }
  } catch (error) {
    console.error('Error parsing user data:', error);
  }

  // Función para obtener badge de estado
  function getEstadoBadge(estado: string): string {
    const badges: Record<string, string> = {
      'pendiente': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pendiente</span>',
      'habilitado': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Habilitado</span>',
      'observado': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">Observado</span>',
      'suspendido': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Suspendido</span>',
      'revocado': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Revocado</span>',
    };
    return badges[estado] || estado;
  }

  // Función para cargar conductores
  async function loadConductores() {
    const searchInput = document.getElementById('search') as HTMLInputElement;
    const estadoFilter = document.getElementById('estadoFilter') as HTMLSelectElement;
    const tableBody = document.getElementById('conductoresTableBody')!;

    try {
      const response = await conductoresService.getAll({
        page: currentPage,
        size: pageSize,
        search: searchInput.value || undefined,
        estado: estadoFilter.value || undefined,
      });

      totalPages = response.pages;

      // Actualizar tabla
      if (response.items.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
              No se encontraron conductores
            </td>
          </tr>
        `;
      } else {
        tableBody.innerHTML = response.items.map((conductor: Conductor) => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
              ${conductor.dni}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">${conductor.nombres} ${conductor.apellidos}</div>
              <div class="text-sm text-gray-500">${conductor.email}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">${conductor.licencia_numero}</div>
              <div class="text-sm text-gray-500">Cat. ${conductor.licencia_categoria}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              ${conductor.empresa?.razon_social || 'N/A'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              ${getEstadoBadge(conductor.estado)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <a href="/conductores/${conductor.id}" class="text-blue-600 hover:text-blue-900 mr-3">
                Ver
              </a>
              <a href="/conductores/${conductor.id}/editar" class="text-green-600 hover:text-green-900">
                Editar
              </a>
            </td>
          </tr>
        `).join('');
      }

      // Actualizar paginación
      document.getElementById('showingFrom')!.textContent = ((currentPage - 1) * pageSize + 1).toString();
      document.getElementById('showingTo')!.textContent = Math.min(currentPage * pageSize, response.total).toString();
      document.getElementById('totalItems')!.textContent = response.total.toString();

      // Actualizar botones de paginación
      const prevButton = document.getElementById('prevPage') as HTMLButtonElement;
      const nextButton = document.getElementById('nextPage') as HTMLButtonElement;
      prevButton.disabled = currentPage === 1;
      nextButton.disabled = currentPage >= totalPages;

    } catch (error) {
      console.error('Error loading conductores:', error);
      tableBody.innerHTML = `
        <tr>
          <td colspan="6" class="px-6 py-4 text-center text-red-500">
            Error al cargar conductores. Por favor, intenta de nuevo.
          </td>
        </tr>
      `;
    }
  }

  // Event listeners
  document.getElementById('searchButton')?.addEventListener('click', () => {
    currentPage = 1;
    loadConductores();
  });

  document.getElementById('search')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      currentPage = 1;
      loadConductores();
    }
  });

  document.getElementById('estadoFilter')?.addEventListener('change', () => {
    currentPage = 1;
    loadConductores();
  });

  document.getElementById('prevPage')?.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      loadConductores();
    }
  });

  document.getElementById('nextPage')?.addEventListener('click', () => {
    if (currentPage < totalPages) {
      currentPage++;
      loadConductores();
    }
  });

  // Cargar conductores al iniciar
  loadConductores();
</script>
